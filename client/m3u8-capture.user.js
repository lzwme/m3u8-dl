// ==UserScript==
// @name         [M3U8-DL]åª’ä½“é“¾æ¥æŠ“å–å™¨
// @namespace    https://github.com/lzwme/m3u8-dl
// @homepage     https://m3u8-player.lzw.me/download.html
// @supportURL   https://github.com/lzwme/m3u8-dl/issues
// @icon         https://gh-proxy.org/raw.githubusercontent.com/lzwme/m3u8-dl/refs/heads/main/packages/frontend/public/logo.png
// @version      1.0.4
// @description  è‡ªåŠ¨æŠ“å–ç½‘é¡µä¸­çš„å¤šç§åª’ä½“é“¾æ¥ï¼ˆm3u8ã€mp4ã€mkvã€aviã€movã€éŸ³é¢‘ç­‰ï¼‰ï¼Œæ”¯æŒå¯é…ç½®çš„åª’ä½“ç±»å‹ï¼Œæ”¯æŒè·³è½¬åˆ° m3u8-dl webui ä¸‹è½½
// @author       lzw
// @updateURL    https://gh-proxy.org/raw.githubusercontent.com/lzwme/m3u8-dl/refs/heads/main/client/m3u8-capture.user.js
// @downloadURL  https://raw.githubusercontent.com/lzwme/m3u8-dl/refs/heads/main/client/m3u8-capture.user.js
// @match        *://*/*
// @grant        GM_addElement
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_getResourceText
// @grant        GM_xmlhttpRequest
// @grant        unsafeWindow
// @resource     SwalJS   https://s4.zstatic.net/ajax/libs/sweetalert2/11.16.1/sweetalert2.min.js
// @resource     SwalCSS  https://s4.zstatic.net/ajax/libs/sweetalert2/11.16.1/sweetalert2.css
// @resource     TailwindCSS  https://s4.zstatic.net/ajax/libs/tailwindcss/2.2.19/tailwind.min.css
// @run-at       document-idle
// ==/UserScript==

(function(){"use strict";const X="m3u8_capture_webui_url",N="m3u8_capture_exclude_urls",K="m3u8_capture_panel_pos",J="m3u8_capture_panel_visible",Q="m3u8_capture_media_ext_list",Z="m3u8_capture_auto_start",ee="m3u8_capture_title_replace_rules",te="m3u8_capture_auto_close_webui",ne="m3u8_capture_capture_headers",_e=["m3u8","mp4","mkv","avi","mov","wmv","flv","webm","m4v","m3u","m4a","aac","flac","ape","mp3","wav","ogg","wma"],Me=["localhost:6600","/example.com/","lzw.me","doubleclick.net"];function H(){return GM_getValue(X,"http://localhost:6600").replace(/\/$/,"")}function oe(){return GM_getValue(N,"")}function Le(e){GM_setValue(N,e)}function B(){const e=GM_getValue(Q,[]);return e&&Array.isArray(e)&&e.length>0?e:[..._e]}function Te(e){if(Array.isArray(e)&&e.length>0){const t=e.map(r=>r.trim().toLowerCase()).filter(r=>r&&/^[a-z0-9]+$/i.test(r));return GM_setValue(Q,t),t}return null}function Re(){return GM_getValue(K,null)}function Ue(e){GM_setValue(K,e)}function $e(){return GM_getValue(J,!1)}function re(e){GM_setValue(J,e)}function ae(){return GM_getValue(Z,!1)}function Ae(e){GM_setValue(Z,e)}function se(){return GM_getValue(ee,"")}function ke(e){GM_setValue(ee,e)}function ie(){return GM_getValue(te,!1)}function Ie(e){GM_setValue(te,e)}function le(){return GM_getValue(ne,!1)}function Be(e){GM_setValue(ne,e)}const h=window.top&&window.top!==window.self;function V(e,t=document.head,r="css"){const o=e.length<50?GM_getResourceText(e):e;return Promise.resolve(GM_addElement(t,r==="css"?"style":"script",{type:r==="css"?"text/css":"text/javascript",textContent:o}))}function We(){const e=B();return new RegExp(`\\.(${e.join("|")})(\\?|$|#)`,"i")}function _(e){const t=e||window.location.href;if(t.startsWith(H()))return!0;const r=[...Me],o=oe();o.trim()&&r.push(...o.split(`
`).map(n=>n.trim()).filter(n=>n));for(const n of r)try{if(t.includes(n)||n.startsWith("/")&&n.endsWith("/")&&new RegExp(n.slice(1,-1)).test(t))return!0}catch(a){console.warn("[M3U8 Capture] æ’é™¤è§„åˆ™æ ¼å¼é”™è¯¯:",n,a)}return!1}function ce(e){return new Promise((t,r)=>{navigator.clipboard?.writeText?navigator.clipboard.writeText(e).then(()=>t(!0)).catch(()=>{ue(e)?t(!0):r(new Error("å¤åˆ¶å¤±è´¥"))}):ue(e)?t(!0):r(new Error("å¤åˆ¶å¤±è´¥"))})}function ue(e){try{const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",t.style.left="-9999px",document.body.appendChild(t),t.select(),t.setSelectionRange(0,e.length);const r=document.execCommand("copy");return document.body.removeChild(t),r}catch(t){return console.error("[M3U8 Capture] fallbackCopy failed:",t),!1}}function Pe(e){try{const t=new URL(e);return`${t.protocol}//${t.host}${t.pathname}`}catch{return e}}function D(e){return"touches"in e&&e.touches.length>0?{x:e.touches[0].clientX,y:e.touches[0].clientY}:"changedTouches"in e&&e.changedTouches.length>0?{x:e.changedTouches[0].clientX,y:e.changedTouches[0].clientY}:{x:e.clientX,y:e.clientY}}function de(e){if(!e||typeof e!="string"||e==="NaN"||e==="undefined")return"";const t=se();if(!t.trim())return e;try{const r=t.split(/,|\n/).map(n=>n.trim()).filter(n=>n);let o=e;for(const n of r)if(n)try{if(n.startsWith("/")&&n.endsWith("/")&&n.length>2){const a=n.lastIndexOf("/"),l=n.slice(1,a),c=n.slice(a+1),i=new RegExp(l,c);o=o.replace(i,"")}else o=o.replaceAll(n,"")}catch(a){console.warn("[M3U8 Capture] æ ‡é¢˜æ›¿æ¢è§„åˆ™æ ¼å¼é”™è¯¯:",n,a)}return o=o.replace(/\s+/g," ").trim(),o}catch(r){return console.warn("[M3U8 Capture] åº”ç”¨æ ‡é¢˜æ›¿æ¢è§„åˆ™å¤±è´¥:",r),e}}function Ge(e){return e==null?!0:Array.isArray(e)?e.length===0:Object.keys(e).length===0}function fe(e,t=!1){if(!e||Ge(e))return"";const r=Object.entries(e).map(([o,n])=>`${o}: ${n}`).join(`
`);return t?encodeURIComponent(r):r}async function Oe(){let e=document.body;const t=o=>{e=o},r=()=>e;unsafeWindow.SetSwalTarget=t,window.SetSwalTarget=t,unsafeWindow.GetSwalTarget=r,window.GetSwalTarget=r;try{const o=GM_getResourceText("SwalJS").replace(/document\.body/g,"GetSwalTarget()"),n=()=>V(o,document.head||document.documentElement,"script").then(()=>{const a=window.Swal||window.Sweetalert2||unsafeWindow.Swal||unsafeWindow.Sweetalert2;a&&(window.Swal=a,unsafeWindow.Swal=a)}).catch(a=>{console.error("[M3U8 Capture] Failed to add SweetAlert2 script:",a)});document.head||document.documentElement?await n():document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>n()):setTimeout(n,50)}catch(o){console.error("[M3U8 Capture] Failed to load SweetAlert2:",o)}}function He(e,t){V(GM_getResourceText("SwalCSS").replace(/(\d+)rem/g,"$1em").replace(/:root *{/,`#${t.id} {`).replace(/body/g,""),e,"css"),setTimeout(()=>{const r=window.Swal;typeof window.SetSwalTarget=="function"&&r&&(window.SetSwalTarget(t),window.Swal=r.mixin({target:t}))},500)}function Ve(e){V(GM_getResourceText("TailwindCSS").replace(/(\d+)rem/g,"$1em"),e,"css")}let M=null,v=null,d=null,s=null,b=null,A=$e(),W=!1;const P={x:0,y:0};let L=!1;const G={x:0,y:0};let q={x:0,y:0},T=!1,R=null;const E={x:0,y:0};function pe(){if(M)return v;M=document.createElement("div"),M.id="m3u8-capture-shadow-host",M.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999;",document.body.appendChild(M),v=M.attachShadow({mode:"open"});const e=document.createElement("div");e.id="m3u8-capture-swal-container",v.appendChild(e);const t=document.createElement("style");return t.textContent=[":host { all: initial; font-family: system-ui, -apple-system, sans-serif; font-size: 14px }","* { box-sizing: border-box; }",".hidden { display: none !important; }",`#${e.id},`,`#${e.id} * { pointer-events: auto !important; }`].join(`
`),v.appendChild(t),He(v,e),Ve(v),Oe(),v}function me(){if(s||h)return;const e=pe();if(!e)return;s=document.createElement("div"),s.id="m3u8-capture-toggle-btn",s.style.cssText="position: fixed; bottom: 30vh; right: 20px; width: 50px; height: 50px; pointer-events: auto; z-index: 99998; will-change: transform;",s.className=`fixed bottom-10 right-5 w-[50px] h-[50px] bg-blue-500 rounded-full flex items-center justify-center cursor-move shadow-lg text-2xl transition-all duration-200 hover:scale-110 hover:shadow-xl select-none touch-none ${A?"hidden":"flex"}`;const t=document.createElement("span");t.textContent="ğŸ¬",s.appendChild(t),b=document.createElement("span"),b.id="m3u8-capture-toggle-badge",b.style.cssText="position: absolute; top: -4px; right: -4px; min-width: 18px; height: 18px; background: #ef4444; color: white; border-radius: 9px; font-size: 11px; font-weight: bold; display: flex; align-items: center; justify-content: center; padding: 0 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); line-height: 1;",b.textContent="0",b.classList.add("hidden"),s.appendChild(b);const r=o=>{if(!s)return;L=!0,T=!1;const n=D(o);q={x:n.x,y:n.y};const a=s.getBoundingClientRect();G.x=n.x-a.left,G.y=n.y-a.top,E.x=a.left,E.y=a.top;const l=window.getComputedStyle(s);l.transform&&l.transform!=="none"&&(s.style.transform="none",s.style.left=`${a.left}px`,s.style.top=`${a.top}px`,s.style.right="auto",s.style.bottom="auto"),s.style.cursor="move",s.style.transition="none",o.preventDefault(),o.stopPropagation()};s.addEventListener("mousedown",r),s.addEventListener("touchstart",r,{passive:!1}),s.addEventListener("click",()=>{T||ge()}),s.addEventListener("touchend",o=>{L&&!T&&(o.preventDefault(),o.stopPropagation(),ge())},{passive:!1}),e.appendChild(s),z()}function z(){if(!b||h||!x)return;const e=x.size;e>0?(b.textContent=e>99?"99+":e.toString(),b.classList.remove("hidden")):b.classList.add("hidden")}function ge(){h||!xe()||(A=!0,re(!0),d&&(d.style.display="flex"),s&&s.classList.add("hidden"))}function j(){h||(A=!1,re(!1),d&&(d.style.display="none"),s?s.classList.remove("hidden"):me(),z())}function he(){const e=window.Swal;e&&e.fire({title:"ç¡®è®¤æ¸…ç©º",text:"ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰åª’ä½“é“¾æ¥å—ï¼Ÿ",icon:"warning",showCancelButton:!0,confirmButtonText:"ç¡®å®š",cancelButtonText:"å–æ¶ˆ",confirmButtonColor:"#3b82f6"}).then(t=>{t.isConfirmed&&x&&(x.clear(),Y())})}function xe(){if(!document.body||h)return null;if(d)return d;const e=pe();if(!e)return null;const t=document.createElement("div");t.id="m3u8-capture-panel";const r=Re(),o=r&&window.innerWidth>768?{left:`${Math.max(0,Math.min(r.x,window.innerWidth-450))}px`,top:`${Math.max(0,Math.min(r.y,window.innerHeight-350))}px`,right:"auto"}:{right:"20px",top:"30vh"};t.className="fixed w-[420px] max-w-[90vw] max-h-[85vh] bg-white border-2 border-blue-500 rounded-xl shadow-2xl font-sans flex flex-col",t.style.cssText=`
          position: fixed;
          width: 420px;
          max-width: 90vw;
          max-height: 85vh;
          pointer-events: auto;
          z-index: 1059;
          ${o.left?`left: ${o.left};`:""}
          ${o.top?`top: ${o.top};`:""}
          ${`right: ${o.right};`}
          display: ${A?"flex":"none"};
      `,t.innerHTML=`
          <div id="m3u8-capture-header" class="bg-gradient-to-br from-blue-500 to-blue-600 text-white px-4 py-3.5 rounded-t-lg flex justify-between items-center cursor-move select-none touch-none">
              <div class="font-semibold text-[15px] flex items-center gap-2">
                  <span>ğŸ¬</span>
                  <span>åª’ä½“é“¾æ¥æŠ“å–å™¨</span>
                  <span id="m3u8-capture-count" class="bg-white bg-opacity-25 px-2 py-0.5 rounded-xl text-xs font-medium">0</span>
              </div>
              <div class="flex gap-1.5">
                  <button id="m3u8-capture-settings" class="bg-white bg-opacity-20 border-none text-white px-2.5 py-1.5 rounded-md cursor-pointer text-xs transition-colors duration-200 hover:bg-opacity-30 active:bg-opacity-40 touch-manipulation" title="è®¾ç½®">âš™ï¸</button>
                  <button id="m3u8-capture-toggle" class="bg-white bg-opacity-20 border-none text-white px-2.5 py-1.5 rounded-md cursor-pointer text-xs transition-colors duration-200 hover:bg-opacity-30 active:bg-opacity-40 touch-manipulation" title="éšè—">âˆ’</button>
                  <button id="m3u8-capture-clear" class="bg-white bg-opacity-20 border-none text-white px-2.5 py-1.5 rounded-md cursor-pointer text-xs transition-colors duration-200 hover:bg-opacity-30 active:bg-opacity-40 touch-manipulation" title="æ¸…ç©º">ğŸ—‘ï¸</button>
              </div>
          </div>
          <div id="m3u8-capture-content" class="p-3 overflow-y-auto flex-1 bg-gray-50">
              <div id="m3u8-capture-list" class="flex flex-col gap-2.5"></div>
              <div id="m3u8-capture-empty" class="text-center text-gray-400 py-10 px-5 hidden">
                  <div class="text-5xl mb-3">ğŸ“¹</div>
                  <div class="text-sm">æš‚æ— åª’ä½“é“¾æ¥</div>
                  <div class="text-xs text-gray-300 mt-2">æµè§ˆç½‘é¡µæ—¶ä¼šè‡ªåŠ¨æŠ“å–</div>
              </div>
          </div>
      `,e.appendChild(t),d=t;const n=t.querySelector("#m3u8-capture-header");if(!n)return d;const a=f=>{const m=f.target;if(m.tagName==="BUTTON"||m.closest("button"))return;W=!0;const w=D(f),y=t.getBoundingClientRect();P.x=w.x-y.left,P.y=w.y-y.top,t.style.cursor="move",f.preventDefault(),f.stopPropagation()};n.addEventListener("mousedown",a),n.addEventListener("touchstart",a,{passive:!1});const l=f=>{const m=D(f);if(W&&d){f.preventDefault();const w=m.x-P.x,y=m.y-P.y,k=window.innerWidth-t.offsetWidth,I=window.innerHeight-t.offsetHeight,U=Math.max(0,Math.min(w,k)),$=Math.max(0,Math.min(y,I));t.style.left=`${U}px`,t.style.top=`${$}px`,t.style.right="auto",Ue({x:U,y:$})}if(L&&s){f.preventDefault();const w=m.x-G.x,y=m.y-G.y,k=window.innerWidth-s.offsetWidth,I=window.innerHeight-s.offsetHeight,U=Math.max(0,Math.min(w,k)),$=Math.max(0,Math.min(y,I));E.x=U,E.y=$,R||(R=requestAnimationFrame(()=>{s&&L&&(s.style.transform=`translate(${E.x}px, ${E.y}px)`,s.style.left="0",s.style.top="0",s.style.right="auto",s.style.bottom="auto"),R=null})),Math.sqrt((m.x-q.x)**2+(m.y-q.y)**2)>5&&(T=!0)}},c=f=>{W&&(W=!1,d&&(d.style.cursor="default"),f.preventDefault()),L&&(L=!1,R&&(cancelAnimationFrame(R),R=null),s&&(s.style.cursor="move",s.style.transition="",T&&(s.style.transform=`translate(${E.x}px, ${E.y}px)`,s.style.left="0",s.style.top="0",s.style.right="auto",s.style.bottom="auto")),T&&f.preventDefault())};document.addEventListener("mousemove",l),document.addEventListener("mouseup",c),document.addEventListener("touchmove",l,{passive:!1}),document.addEventListener("touchend",c,{passive:!1}),document.addEventListener("touchcancel",c,{passive:!1});const i=f=>m=>{m.preventDefault(),m.stopPropagation(),f()},u=t.querySelector("#m3u8-capture-toggle");u&&(u.addEventListener("click",i(()=>j())),u.addEventListener("touchend",i(()=>j()),{passive:!1}));const p=t.querySelector("#m3u8-capture-clear");p&&(p.addEventListener("click",i(()=>he())),p.addEventListener("touchend",i(()=>he()),{passive:!1}));const g=t.querySelector("#m3u8-capture-settings");return g&&(g.addEventListener("click",i(()=>we())),g.addEventListener("touchend",i(()=>we()),{passive:!1})),!A&&!s&&me(),d}function we(e=v){const t=window.Swal;if(!t)return;const r=oe(),o=B(),n=ae(),a=se(),l=ie(),c=le();t.fire({title:"è®¾ç½®",html:`
              <div class="text-left">
                  <label class="block text-sm font-medium text-gray-700 mb-1">WebUI åœ°å€</label>
                  <input id="swal-webui-url" type="text" value="${H()}"
                      class="w-full p-2.5 border border-gray-300 rounded-md mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder="http://localhost:6600">
                  <label class="block text-sm font-medium text-gray-700 mb-1">åª’ä½“æ‰©å±•åï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œç”¨é€—å·æˆ–æ¢è¡Œåˆ†éš”ï¼‰</label>
                  <textarea id="swal-media-ext-list" rows="2"
                      class="w-full p-2.5 border border-gray-300 rounded-md mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder="ä¾‹å¦‚ï¼šm3u8, mp4, mkv, avi, mov, wmv, flv, webm, m4v, ts, m3u, m4a, aac, flac, ape, mp3, wav, ogg, wma">${o.join(", ")}</textarea>
                  <p class="text-xs text-gray-500 mb-4">æ”¯æŒçš„åª’ä½“æ–‡ä»¶æ‰©å±•åï¼Œå°†ç”¨äºè¯†åˆ«å’ŒæŠ“å–åª’ä½“é“¾æ¥</p>
                  <label class="block text-sm font-medium text-gray-700 mb-1">æ’é™¤ç½‘å€è§„åˆ™ï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œæ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ï¼Œä»¥ / å¼€å¤´å’Œç»“å°¾ï¼‰</label>
                  <textarea id="swal-exclude-urls" rows="2"
                      class="w-full p-2.5 border border-gray-300 rounded-md mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder="ä¾‹å¦‚ï¼š&#10;localhost:6600&#10;/example.com/&#10;127.0.0.1">${r}</textarea>
                  <p class="text-xs text-gray-500 mb-4">åŒ¹é…çš„ç½‘å€å°†ä¸å±•ç¤ºé¢æ¿ä¸”ä¸æŠ“å–åª’ä½“é“¾æ¥</p>
                  <label class="block text-sm font-medium text-gray-700 mb-1">æ ‡é¢˜å†…å®¹æ›¿æ¢è§„åˆ™ï¼ˆæ”¯æŒæ­£åˆ™ï¼Œå¤šä¸ªè§„åˆ™ä»¥é€—å·åˆ†å‰²ï¼‰</label>
                  <textarea id="swal-title-replace-rules" rows="2"
                      class="w-full p-2.5 border border-gray-300 rounded-md mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder="ä¾‹å¦‚ï¼š/\\[.*?\\]//g, /ç¬¬.*?è¯//g">${a}</textarea>
                  <p class="text-xs text-gray-500 mb-4">åœ¨è·å–æ ‡é¢˜åï¼Œå°†æ ¹æ®è¿™äº›è§„åˆ™è¿›è¡Œæ›¿æ¢ã€‚æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ï¼Œæ ¼å¼ï¼š/pattern/flags æˆ– plain-text</p>
                  <div class="flex items-center mb-4">
                      <input id="swal-auto-start" type="checkbox" ${n?"checked":""}
                          class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                      <label for="swal-auto-start" class="ml-2 text-sm font-medium text-gray-700">è‡ªåŠ¨å¼€å§‹ä¸‹è½½</label>
                  </div>
                  <p class="text-xs text-gray-500 mb-4">å¯ç”¨åï¼Œè·³è½¬åˆ°ä¸‹è½½é¡µé¢æ—¶å°†è‡ªåŠ¨è§¦å‘å¼€å§‹ä¸‹è½½ï¼ˆå»¶è¿Ÿ1ç§’ï¼‰</p>
                  <div class="flex items-center mb-4">
                      <input id="swal-auto-close-webui" type="checkbox" ${l?"checked":""}
                          class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                      <label for="swal-auto-close-webui" class="ml-2 text-sm font-medium text-gray-700">å¼€å§‹ä¸‹è½½åè‡ªåŠ¨å…³é—­WebUIé¡µé¢</label>
                  </div>
                  <p class="text-xs text-gray-500 mb-4">ä»…å½“"è‡ªåŠ¨å¼€å§‹ä¸‹è½½"å¼€å¯æ—¶æœ‰æ•ˆï¼Œå¼€å§‹ä¸‹è½½åå°†è‡ªåŠ¨å…³é—­æ‰“å¼€çš„WebUIé¡µé¢</p>
                  <div class="flex items-center mb-4">
                      <input id="swal-capture-headers" type="checkbox" ${c?"checked":""}
                          class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                      <label for="swal-capture-headers" class="ml-2 text-sm font-medium text-gray-700">æºå¸¦è¯·æ±‚ header</label>
                  </div>
                  <p class="text-xs text-gray-500">å¯ç”¨åï¼Œè·³è½¬ä¸‹è½½æ—¶ä¼šæºå¸¦è¯·æ±‚ headerã€‚åœ¨éœ€è¦ç™»å½•ã€é˜²ç›—é“¾ç­‰åœºæ™¯ä¸‹ï¼Œå¯ä»¥æé«˜æˆåŠŸç‡</p>
              </div>
          `,showCancelButton:!0,confirmButtonText:"ä¿å­˜",cancelButtonText:"å–æ¶ˆ",confirmButtonColor:"#3b82f6",width:"600px",preConfirm:()=>{if(!e)return!1;const i=e.getElementById("swal-webui-url"),u=e.getElementById("swal-exclude-urls"),p=e.getElementById("swal-media-ext-list"),g=e.getElementById("swal-title-replace-rules"),f=e.getElementById("swal-auto-start"),m=e.getElementById("swal-auto-close-webui"),w=e.getElementById("swal-capture-headers"),y=i?i.value.trim():"",k=u?u.value.trim():"",I=p?p.value.trim():"",U=g?g.value.trim():"",$=f?f.checked:!1,Ee=m?m.checked:!1,Fe=w?w.checked:!1,Se=window.Swal;if(!y)return Se.showValidationMessage("WebUI åœ°å€ä¸èƒ½ä¸ºç©º"),!1;const Ce=I.split(/[,\n\s]+/).map(F=>F.trim()).filter(F=>F);return Ce.length===0?(Se.showValidationMessage("åª’ä½“æ‰©å±•ååˆ—è¡¨ä¸èƒ½ä¸ºç©º"),!1):{url:y,excludeUrls:k,mediaExtList:Ce,titleReplaceRules:U,autoStart:$,autoCloseWebui:Ee,captureHeaders:Fe}}}).then(i=>{if(i.isConfirmed&&i.value){const u=i.value;GM_setValue(X,u.url),Le(u.excludeUrls),Ae(u.autoStart),Ie(u.autoCloseWebui),ke(u.titleReplaceRules),Be(u.captureHeaders);const p=Te(u.mediaExtList),g=window.Swal;if(p&&g){let f=`å·²ä¿å­˜ ${p.length} ä¸ªåª’ä½“æ‰©å±•åç±»å‹`;if(u.titleReplaceRules){const m=u.titleReplaceRules.split(",").filter(w=>w.trim()).length;f+=`<br>å·²è®¾ç½® ${m} ä¸ªæ ‡é¢˜æ›¿æ¢è§„åˆ™`}u.autoCloseWebui&&(f+="<br>å·²å¯ç”¨è‡ªåŠ¨å…³é—­WebUIé¡µé¢"),g.fire({icon:"success",title:"è®¾ç½®å·²ä¿å­˜",html:f,timer:2500,showConfirmButton:!1})}else g&&g.fire({icon:"error",title:"ä¿å­˜å¤±è´¥",text:"åª’ä½“æ‰©å±•ååˆ—è¡¨æ ¼å¼é”™è¯¯",timer:2e3,showConfirmButton:!1})}})}function be(e){const t=window.top&&window.top!==window;try{const o=window.open(e,"_blank");if(o&&!o.closed)return!0}catch(o){console.log("[M3U8 Capture] window.open failed:",o)}if(t&&window.top){try{const o=window.top.open(e,"_blank");if(o&&!o.closed)return!0}catch(o){console.log("[M3U8 Capture] window.top.open failed:",o)}try{return window.top.location.href=e,!0}catch(o){console.log("[M3U8 Capture] window.top.location.href failed:",o)}}const r=()=>{const o=window.Swal;o&&o.fire({icon:"info",title:"é“¾æ¥å·²å¤åˆ¶",html:`ç”±äº iframe é™åˆ¶ï¼Œé“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿<br><br><code style="word-break: break-all; background: #f3f4f6; padding: 8px; border-radius: 4px; display: block; font-size: 12px;">${e}</code><br><br>è¯·æ‰‹åŠ¨æ‰“å¼€`,timer:4e3,showConfirmButton:!0,confirmButtonText:"ç¡®å®š"})};return ce(e).then(()=>r()).catch(()=>{const o=window.Swal;o&&o.fire({icon:"warning",title:"æ— æ³•å¤åˆ¶é“¾æ¥",html:`ç”±äº iframe é™åˆ¶ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶å¹¶æ‰“å¼€ï¼š<br><br><code style="word-break: break-all; background: #f3f4f6; padding: 8px; border-radius: 4px; display: block; font-size: 12px;">${e}</code>`,confirmButtonText:"ç¡®å®š"})}),!1}function Y(){if(console.log("updateUI",h,x,d),h||!x||!xe()||!d)return;z();const e=d.querySelector("#m3u8-capture-list"),t=d.querySelector("#m3u8-capture-empty"),r=d.querySelector("#m3u8-capture-count");if(!e||!t||!r)return;if(r.textContent=x.size.toString(),x.size===0){e.classList.add("hidden"),t.classList.remove("hidden");return}e.classList.remove("hidden"),t.classList.add("hidden"),e.innerHTML="",Array.from(x.values()).sort((n,a)=>a.timestamp-n.timestamp).forEach(n=>{const a=document.createElement("div");a.className="border border-gray-200 rounded-lg p-3 bg-white transition-all duration-200 shadow-sm hover:bg-gray-50 hover:shadow-md";const l=n.title||"",c=n.type.toUpperCase();let i="bg-gray-500";c==="M3U8"||c==="M3U"?i="bg-blue-500":["MP4","MKV","AVI","MOV","WMV","FLV","WEBM","M4V","TS"].includes(c)?i="bg-green-500":["MP3","M4A","AAC","FLAC","APE","WAV","OGG","WMA"].includes(c)&&(i="bg-purple-500"),a.innerHTML=`
              <div class="flex justify-between items-start gap-2 mb-2">
                  <div class="flex-1 min-w-0">
                      <div class="flex items-center gap-1.5 mb-1.5">
                          <span class="font-semibold text-[13px] text-gray-900 overflow-hidden text-ellipsis whitespace-nowrap" title="${l}">${l||"æœªå‘½ååª’ä½“"}</span>
                          <span class="${i} text-white px-2 py-0.5 rounded-xl text-[10px] font-bold">${c}</span>
                      </div>
                      <div class="text-[11px] text-gray-500 overflow-hidden text-ellipsis whitespace-nowrap leading-snug max-w-[320px]" title="${n.url}">${n.url}</div>
                  </div>
              </div>
              <div class="flex gap-2">
                  <button class="m3u8-capture-download-btn flex-1 bg-blue-500 text-white border-none px-3.5 py-2 rounded-md cursor-pointer text-xs font-medium transition-all duration-200 hover:bg-blue-600 hover:-translate-y-0.5"
                  data-url="${encodeURIComponent(n.url)}"
                  data-title="${encodeURIComponent(l)}"
                  data-headers="${fe(n.headers,!0)}">
                      è·³è½¬ä¸‹è½½
                  </button>
                  <button class="m3u8-capture-preview-btn bg-green-500 text-white border-none px-3.5 py-2 rounded-md cursor-pointer text-xs font-medium transition-all duration-200 hover:bg-green-600" data-url="${encodeURIComponent(n.url)}">
                      é¢„è§ˆ
                  </button>
                  <button class="m3u8-capture-copy-btn bg-gray-500 text-white border-none px-3.5 py-2 rounded-md cursor-pointer text-xs transition-all duration-200 hover:bg-gray-600" data-url="${n.url}">
                      å¤åˆ¶
                  </button>
              </div>
          `,e.appendChild(a)}),d.querySelectorAll(".m3u8-capture-download-btn").forEach(n=>{n.addEventListener("click",a=>{a.stopPropagation();const l=decodeURIComponent(n.getAttribute("data-url")||""),c=decodeURIComponent(n.getAttribute("data-title")||""),i=ae()?"&autoStart=1":"",u=i&&ie()?"&autoClose=1":"";let p=`${H()}/page/download?from=capture&action=new${i}${u}&url=${encodeURIComponent(l+(c?`|${c}`:""))}`;if(le()){let g=n.getAttribute("data-headers");g||(g=fe({referer:window.location.href,cookie:document.cookie},!0)),g&&(p+=`#headers=${g}`)}be(p)})}),d.querySelectorAll(".m3u8-capture-preview-btn").forEach(n=>{n.addEventListener("click",a=>{a.stopPropagation();const l=decodeURIComponent(n.getAttribute("data-url")||""),c=`https://m3u8-player.lzw.me?from=capture&url=${encodeURIComponent(l)}`;be(c)})}),d.querySelectorAll(".m3u8-capture-copy-btn").forEach(n=>{n.addEventListener("click",async a=>{a.stopPropagation();const l=n.getAttribute("data-url")||"",c=n.textContent,i=n.className;try{await ce(l),n.textContent="å·²å¤åˆ¶",n.className="m3u8-capture-copy-btn bg-green-500 text-white border-none px-3.5 py-2 rounded-md cursor-pointer text-xs transition-all duration-200",setTimeout(()=>{n.textContent=c,n.className=i},2e3)}catch{const p=window.Swal;if(!p)return;p.fire({icon:"error",title:"å¤åˆ¶å¤±è´¥",text:"è¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥",html:`<code style="word-break: break-all; background: #f3f4f6; padding: 8px; border-radius: 4px; display: block; font-size: 12px;">${l}</code>`,confirmButtonText:"ç¡®å®š"})}})})}const x=new Map;function S(e,t="",r={}){if(e=qe(e)||e,!e||_(e))return;const o=Pe(e),n=x.get(o)||{},a=t||n.title||ye()||"",l={timestamp:Date.now(),url:e,pageUrl:window.location.href,title:de(a).trim(),type:De(e)||n.type||"",headers:Object.assign(r,n.headers||{})};if(h){try{console.log("send link to top window",l),window.top.postMessage({type:"m3u8-capture-link",data:l},"*")}catch(c){console.warn("[M3U8 Capture] Failed to send link to top window:",c)}return}x.set(o,l),Y()}function C(e){if(!e||typeof e!="string"||!e.startsWith("http"))return!1;const t=e.toLowerCase();return!!(We().test(t)||t.includes(".m3u8"))}function De(e){if(!e||typeof e!="string")return"media";const t=e.toLowerCase(),r=B();for(const o of r)if(new RegExp(`\\.${o}(\\?|$|#)`,"i").test(t))return o;return/m3u8/i.test(t)?"m3u8":"media"}function ye(e=document){let t="";const r=["h2.title","h1.title","div.sub-title","div.title","h2","h1"];for(const o of r){const n=e.querySelector(o);if(n&&(t=de(n.textContent),t))break}if(!t){try{h?t=ye(window.top.document):t=(e.title||"").split(/ [-|_] /)[0].trim()}catch{}console.log("title2",t,h)}return t}function qe(e){if(!e||typeof e!="string")return null;try{const t=new URL(e);for(const[r,o]of t.searchParams.entries()){if(!o)continue;const n=decodeURIComponent(o);if(C(n))return n}}catch{}return null}function ve(e){const t={};e instanceof Headers?e.forEach((o,n)=>{t[n.toLowerCase()]=o}):Object.keys(e).forEach(o=>{t[o.toLowerCase()]=e[o]});const r=["accept","accept-encoding","accept-language","connection","content-length","upgrade-insecure-requests"];return Object.keys(t).forEach(o=>{(r.includes(o)||o.startsWith("sec-")||t[o]==null)&&delete t[o]}),t}function ze(){const e=XMLHttpRequest.prototype.open,t=XMLHttpRequest.prototype.setRequestHeader,r=new WeakMap;XMLHttpRequest.prototype.open=function(n,a,l,c,i){return C(a.toString())&&(r.set(this,{}),this.addEventListener("load",function(){if(this.status>=200&&this.status<300){const u=r.get(this)||{},p=ve(u);S(a.toString(),"",p)}})),e.call(this,n,a,l??!0,c,i)},XMLHttpRequest.prototype.setRequestHeader=function(n,a){const l=r.get(this)||{};return l[n]=a,r.set(this,l),t.call(this,n,a)};const o=window.fetch;window.fetch=function(n,a){const l=typeof n=="string"?n:n&&typeof n=="object"&&"url"in n?n.url:"";if(C(l)){let c={};return a?.headers&&(a.headers instanceof Headers?a.headers.forEach((i,u)=>{c[u]=i}):Array.isArray(a.headers)?a.headers.forEach(([i,u])=>{c[i]=u}):c=a.headers),n instanceof Request&&n.headers.forEach((i,u)=>{c[u]=i}),o.call(this,n,a).then(i=>(i.ok&&S(l,"",ve(c)),i))}return o.call(this,n,a)}}function je(){if(typeof PerformanceObserver>"u")return;const e=new PerformanceObserver(t=>{for(const r of t.getEntries())r.name&&C(r.name)&&S(r.name)});try{e.observe({entryTypes:["resource"]})}catch{console.log("[M3U8 Capture] PerformanceObserver not supported")}}function O(){if(document.querySelectorAll("video").forEach(e=>{e.src&&C(e.src)&&S(e.src,e.getAttribute("title")||""),e.querySelectorAll("source").forEach(t=>{t.src&&C(t.src)&&S(t.src,e.getAttribute("title")||"")})}),document.querySelectorAll("a[href]").forEach(e=>{const t=e.getAttribute("href");if(t&&C(t))try{const r=new URL(t,window.location.href).href;S(r,e.textContent)}catch{}}),document.body){const e=document.body.innerText||"",r=B().join("|"),o=new RegExp(`https?:\\/\\/[^\\s"'<>]+\\.(${r})(\\?[^\\s"'<>]*)?`,"gi");let n;for(;(n=o.exec(e))!==null;)S(n[0])}}function Ye(){if(_())return;h||window.addEventListener("message",r=>{if(console.log("receive link from top window",r.data),r.data&&r.data.type==="m3u8-capture-link"&&r.data.data){const o=r.data.data;S(o.url,o.title,o.headers)}}),ze(),je();const e=()=>{if(console.log("initUI",h,_()),!_()){if(h)return O();document.body&&(O(),x.size>0&&Y())}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e):setTimeout(e,100);let t=location.href;new MutationObserver(()=>{const r=location.href;if(r!==t){if(t=r,_()){j();return}setTimeout(()=>O(),1e3)}}).observe(document,{subtree:!0,childList:!0}),setInterval(()=>{document.body&&!_()&&O()},5e3)}Ye()})();
