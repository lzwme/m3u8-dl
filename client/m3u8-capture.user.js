// ==UserScript==
// @name         [M3U8-DL]åª’ä½“é“¾æ¥æŠ“å–å™¨
// @namespace    https://github.com/lzwme/m3u8-dl
// @homepage     https://m3u8-player.lzw.me/download.html
// @supportURL   https://github.com/lzwme/m3u8-dl/issues
// @icon         https://gh-proxy.org/raw.githubusercontent.com/lzwme/m3u8-dl/refs/heads/main/packages/frontend/public/logo.png
// @version      1.0.0
// @description  è‡ªåŠ¨æŠ“å–ç½‘é¡µä¸­çš„å¤šç§åª’ä½“é“¾æ¥ï¼ˆm3u8ã€mp4ã€mkvã€aviã€movã€éŸ³é¢‘ç­‰ï¼‰ï¼Œæ”¯æŒå¯é…ç½®çš„åª’ä½“ç±»å‹ï¼Œæ”¯æŒè·³è½¬åˆ° m3u8-dl webui ä¸‹è½½
// @author       lzw
// @updateURL    https://gh-proxy.org/raw.githubusercontent.com/lzwme/m3u8-dl/refs/heads/main/client/m3u8-capture.user.js
// @downloadURL  https://raw.githubusercontent.com/lzwme/m3u8-dl/refs/heads/main/client/m3u8-capture.user.js
// @match        *://*/*
// @grant        GM_addElement
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_getResourceText
// @grant        GM_xmlhttpRequest
// @grant        unsafeWindow
// @resource     SwalJS   https://s4.zstatic.net/ajax/libs/sweetalert2/11.16.1/sweetalert2.min.js
// @resource     SwalCSS  https://s4.zstatic.net/ajax/libs/sweetalert2/11.16.1/sweetalert2.css
// @resource     TailwindCSS  https://s4.zstatic.net/ajax/libs/tailwindcss/2.2.19/tailwind.min.css
// @run-at       document-idle
// ==/UserScript==

(function(){"use strict";const N="m3u8_capture_webui_url",j="m3u8_capture_exclude_urls",K="m3u8_capture_panel_pos",J="m3u8_capture_panel_visible",Q="m3u8_capture_media_ext_list",Z="m3u8_capture_auto_start",pt=["m3u8","mp4","mkv","avi","mov","wmv","flv","webm","m4v","m3u","m4a","aac","flac","ape","mp3","wav","ogg","wma"],mt=["localhost:6600","/example.com/","lzw.me","doubleclick.net"];function V(){return GM_getValue(N,"http://localhost:6600").replace(/\/$/,"")}function tt(){return GM_getValue(j,"")}function xt(t){GM_setValue(j,t)}function k(){const t=GM_getValue(Q,[]);return t&&Array.isArray(t)&&t.length>0?t:[...pt]}function gt(t){if(Array.isArray(t)&&t.length>0){const e=t.map(n=>n.trim().toLowerCase()).filter(n=>n&&/^[a-z0-9]+$/i.test(n));return GM_setValue(Q,e),e}return null}function ht(){return GM_getValue(K,null)}function wt(t){GM_setValue(K,t)}function yt(){return GM_getValue(J,!1)}function et(t){GM_setValue(J,t)}function nt(){return GM_getValue(Z,!1)}function bt(t){GM_setValue(Z,t)}function O(t,e=document.head,n="css"){const o=t.length<50?GM_getResourceText(t):t;return Promise.resolve(GM_addElement(e,n==="css"?"style":"script",{type:n==="css"?"text/css":"text/javascript",textContent:o}))}function vt(){const t=k();return new RegExp(`\\.(${t.join("|")})(\\?|$|#)`,"i")}function _(t){const e=t||window.location.href;if(e.startsWith(V()))return!0;const n=[...mt],o=tt();o.trim()&&n.push(...o.split(`
`).map(r=>r.trim()).filter(r=>r));for(const r of n)try{if(e.includes(r)||r.startsWith("/")&&r.endsWith("/")&&new RegExp(r.slice(1,-1)).test(e))return!0}catch(a){console.warn("[M3U8 Capture] æ’é™¤è§„åˆ™æ ¼å¼é”™è¯¯:",r,a)}return!1}function ot(t){return new Promise((e,n)=>{navigator.clipboard?.writeText?navigator.clipboard.writeText(t).then(()=>e(!0)).catch(()=>{rt(t)?e(!0):n(new Error("å¤åˆ¶å¤±è´¥"))}):rt(t)?e(!0):n(new Error("å¤åˆ¶å¤±è´¥"))})}function rt(t){try{const e=document.createElement("textarea");e.value=t,e.style.position="fixed",e.style.opacity="0",e.style.left="-9999px",document.body.appendChild(e),e.select(),e.setSelectionRange(0,t.length);const n=document.execCommand("copy");return document.body.removeChild(e),n}catch(e){return console.error("[M3U8 Capture] fallbackCopy failed:",e),!1}}function Et(t){try{const e=new URL(t);return`${e.protocol}//${e.host}${e.pathname}`}catch{return t}}function W(t){return"touches"in t&&t.touches.length>0?{x:t.touches[0].clientX,y:t.touches[0].clientY}:"changedTouches"in t&&t.changedTouches.length>0?{x:t.changedTouches[0].clientX,y:t.changedTouches[0].clientY}:{x:t.clientX,y:t.clientY}}function S(t){if(!t||typeof t!="string"||!t.startsWith("http"))return!1;const e=t.toLowerCase();return!!(vt().test(e)||e.includes(".m3u8"))}function St(t){if(!t||typeof t!="string")return"media";const e=t.toLowerCase(),n=k();for(const o of n)if(new RegExp(`\\.${o}(\\?|$|#)`,"i").test(e))return o;return/m3u8/i.test(e)?"m3u8":"media"}function it(t=document){let e="";const n=["h1.title","h2.title","h1","h2"];for(const o of n){const r=t.querySelector(o);if(r?.textContent){e=r.textContent.trim();break}}if(e||(e=(t.title||"").split(/ [-|_] /)[0].trim()),!e&&window.top!==window.self)try{e=it(window.top?.document)}catch{}return e}function Ct(t){if(!t||typeof t!="string")return null;try{const e=new URL(t);for(const[n,o]of e.searchParams.entries()){if(!o)continue;const r=decodeURIComponent(o);if(S(r))return r}}catch{}return null}function Lt(){const t=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(n,o,r,a,s){return S(o.toString())&&this.addEventListener("load",function(){this.status>=200&&this.status<300&&v(o.toString())}),t.call(this,n,o,r??!0,a,s)};const e=window.fetch;window.fetch=function(n,o){const r=typeof n=="string"?n:n&&typeof n=="object"&&"url"in n?n.url:"";return S(r)?e.call(this,n,o).then(a=>(a.ok&&v(r),a)):e.call(this,n,o)}}function Mt(){if(typeof PerformanceObserver>"u")return;const t=new PerformanceObserver(e=>{for(const n of e.getEntries())n.name&&S(n.name)&&v(n.name)});try{t.observe({entryTypes:["resource"]})}catch{console.log("[M3U8 Capture] PerformanceObserver not supported")}}function A(){if(document.querySelectorAll("video").forEach(t=>{t.src&&S(t.src)&&v(t.src,t.getAttribute("title")||""),t.querySelectorAll("source").forEach(e=>{e.src&&S(e.src)&&v(e.src,t.getAttribute("title")||"")})}),document.querySelectorAll("a[href]").forEach(t=>{const e=t.getAttribute("href");if(e&&S(e))try{const n=new URL(e,window.location.href).href;v(n,t.textContent?.trim()||"")}catch{}}),document.body){const t=document.body.innerText||"",n=k().join("|"),o=new RegExp(`https?:\\/\\/[^\\s"'<>]+\\.(${n})(\\?[^\\s"'<>]*)?`,"gi");let r;for(;(r=o.exec(t))!==null;)v(r[0])}}async function Tt(){let t=document.body;const e=o=>{t=o},n=()=>t;unsafeWindow.SetSwalTarget=e,window.SetSwalTarget=e,unsafeWindow.GetSwalTarget=n,window.GetSwalTarget=n;try{const o=GM_getResourceText("SwalJS").replace(/document\.body/g,"GetSwalTarget()"),r=()=>O(o,document.head||document.documentElement,"script").then(()=>{const a=window.Swal||window.Sweetalert2||unsafeWindow.Swal||unsafeWindow.Sweetalert2;a&&(window.Swal=a,unsafeWindow.Swal=a)}).catch(a=>{console.error("[M3U8 Capture] Failed to add SweetAlert2 script:",a)});document.head||document.documentElement?await r():document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>r()):setTimeout(r,50)}catch(o){console.error("[M3U8 Capture] Failed to load SweetAlert2:",o)}}function _t(t,e){O(GM_getResourceText("SwalCSS").replace(/:root *{/,`#${e.id} {`).replace(/body/g,""),t,"css"),setTimeout(()=>{const n=window.Swal;typeof window.SetSwalTarget=="function"&&n&&(window.SetSwalTarget(e),window.Swal=n.mixin({target:e}))},500)}const x=window.top&&window.top!==window.self;let C=null,y=null,u=null,i=null,p=null,U=yt(),B=!1;const I={x:0,y:0};let L=!1;const R={x:0,y:0};let q={x:0,y:0},M=!1,T=null;const b={x:0,y:0};let g;function Ut(t){g=t}function at(){if(C)return y;C=document.createElement("div"),C.id="m3u8-capture-shadow-host",C.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999;",document.body.appendChild(C),y=C.attachShadow({mode:"open"}),O("TailwindCSS",y,"css");const t=document.createElement("div");t.id="m3u8-capture-swal-container",y.appendChild(t);const e=document.createElement("style");return e.textContent=[":host { all: initial; font-family: system-ui, -apple-system, sans-serif; }","* { box-sizing: border-box; }",".hidden { display: none !important; }",`#${t.id},`,`#${t.id} * { pointer-events: auto !important; }`].join(`
`),y.appendChild(e),Tt().then(()=>{_t(y,t)}),y}function st(){if(i||x)return;const t=at();if(!t)return;i=document.createElement("div"),i.id="m3u8-capture-toggle-btn",i.style.cssText="position: fixed; bottom: 30vh; right: 20px; width: 50px; height: 50px; pointer-events: auto; z-index: 99998; will-change: transform;",i.className=`fixed bottom-10 right-5 w-[50px] h-[50px] bg-blue-500 rounded-full flex items-center justify-center cursor-move shadow-lg text-2xl transition-all duration-200 hover:scale-110 hover:shadow-xl select-none touch-none ${U?"hidden":"flex"}`;const e=document.createElement("span");e.textContent="ğŸ¬",i.appendChild(e),p=document.createElement("span"),p.id="m3u8-capture-toggle-badge",p.style.cssText="position: absolute; top: -4px; right: -4px; min-width: 18px; height: 18px; background: #ef4444; color: white; border-radius: 9px; font-size: 11px; font-weight: bold; display: flex; align-items: center; justify-content: center; padding: 0 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); line-height: 1;",p.textContent="0",p.classList.add("hidden"),i.appendChild(p);const n=o=>{if(!i)return;L=!0,M=!1;const r=W(o);q={x:r.x,y:r.y};const a=i.getBoundingClientRect();R.x=r.x-a.left,R.y=r.y-a.top,b.x=a.left,b.y=a.top;const s=window.getComputedStyle(i);s.transform&&s.transform!=="none"&&(i.style.transform="none",i.style.left=`${a.left}px`,i.style.top=`${a.top}px`,i.style.right="auto",i.style.bottom="auto"),i.style.cursor="move",i.style.transition="none",o.preventDefault(),o.stopPropagation()};i.addEventListener("mousedown",n),i.addEventListener("touchstart",n,{passive:!1}),i.addEventListener("click",()=>{M||lt()}),i.addEventListener("touchend",o=>{L&&!M&&(o.preventDefault(),o.stopPropagation(),lt())},{passive:!1}),t.appendChild(i),z()}function z(){if(!p||x||!g)return;const t=g.size;t>0?(p.textContent=t>99?"99+":t.toString(),p.classList.remove("hidden")):p.classList.add("hidden")}function lt(){x||!ut()||(U=!0,et(!0),u&&(u.style.display="flex"),i&&i.classList.add("hidden"))}function F(){x||(U=!1,et(!1),u&&(u.style.display="none"),i?i.classList.remove("hidden"):st(),z())}function ct(){const t=window.Swal;t&&t.fire({title:"ç¡®è®¤æ¸…ç©º",text:"ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰åª’ä½“é“¾æ¥å—ï¼Ÿ",icon:"warning",showCancelButton:!0,confirmButtonText:"ç¡®å®š",cancelButtonText:"å–æ¶ˆ",confirmButtonColor:"#3b82f6"}).then(e=>{e.isConfirmed&&g&&(g.clear(),H())})}function ut(){if(!document.body||x)return null;if(u)return u;const t=at();if(!t)return null;const e=document.createElement("div");e.id="m3u8-capture-panel";const n=ht(),o=n&&window.innerWidth>768?{left:`${Math.max(0,Math.min(n.x,window.innerWidth-450))}px`,top:`${Math.max(0,Math.min(n.y,window.innerHeight-350))}px`,right:"auto"}:{right:"20px",top:"20px"};e.className="fixed w-[420px] max-w-[90vw] max-h-[85vh] bg-white border-2 border-blue-500 rounded-xl shadow-2xl font-sans flex flex-col",e.style.cssText=`
          position: fixed;
          width: 420px;
          max-width: 90vw;
          max-height: 85vh;
          pointer-events: auto;
          z-index: 1059;
          ${o.left?`left: ${o.left};`:""}
          ${o.top?`top: ${o.top};`:""}
          ${`right: ${o.right};`}
          display: ${U?"flex":"none"};
      `,e.innerHTML=`
          <div id="m3u8-capture-header" class="bg-gradient-to-br from-blue-500 to-blue-600 text-white px-4 py-3.5 rounded-t-lg flex justify-between items-center cursor-move select-none touch-none">
              <div class="font-semibold text-[15px] flex items-center gap-2">
                  <span>ğŸ¬</span>
                  <span>åª’ä½“é“¾æ¥æŠ“å–å™¨</span>
                  <span id="m3u8-capture-count" class="bg-white bg-opacity-25 px-2 py-0.5 rounded-xl text-xs font-medium">0</span>
              </div>
              <div class="flex gap-1.5">
                  <button id="m3u8-capture-settings" class="bg-white bg-opacity-20 border-none text-white px-2.5 py-1.5 rounded-md cursor-pointer text-xs transition-colors duration-200 hover:bg-opacity-30 active:bg-opacity-40 touch-manipulation" title="è®¾ç½®">âš™ï¸</button>
                  <button id="m3u8-capture-toggle" class="bg-white bg-opacity-20 border-none text-white px-2.5 py-1.5 rounded-md cursor-pointer text-xs transition-colors duration-200 hover:bg-opacity-30 active:bg-opacity-40 touch-manipulation" title="éšè—">âˆ’</button>
                  <button id="m3u8-capture-clear" class="bg-white bg-opacity-20 border-none text-white px-2.5 py-1.5 rounded-md cursor-pointer text-xs transition-colors duration-200 hover:bg-opacity-30 active:bg-opacity-40 touch-manipulation" title="æ¸…ç©º">ğŸ—‘ï¸</button>
              </div>
          </div>
          <div id="m3u8-capture-content" class="p-3 overflow-y-auto flex-1 bg-gray-50">
              <div id="m3u8-capture-list" class="flex flex-col gap-2.5"></div>
              <div id="m3u8-capture-empty" class="text-center text-gray-400 py-10 px-5 hidden">
                  <div class="text-5xl mb-3">ğŸ“¹</div>
                  <div class="text-sm">æš‚æ— åª’ä½“é“¾æ¥</div>
                  <div class="text-xs text-gray-300 mt-2">æµè§ˆç½‘é¡µæ—¶ä¼šè‡ªåŠ¨æŠ“å–</div>
              </div>
          </div>
      `,t.appendChild(e),u=e;const r=e.querySelector("#m3u8-capture-header");if(!r)return u;const a=d=>{const f=d.target;if(f.tagName==="BUTTON"||f.closest("button"))return;B=!0;const w=W(d),m=e.getBoundingClientRect();I.x=w.x-m.left,I.y=w.y-m.top,e.style.cursor="move",d.preventDefault(),d.stopPropagation()};r.addEventListener("mousedown",a),r.addEventListener("touchstart",a,{passive:!1});const s=d=>{const f=W(d);if(B&&u){d.preventDefault();const w=f.x-I.x,m=f.y-I.y,X=window.innerWidth-e.offsetWidth,Y=window.innerHeight-e.offsetHeight,D=Math.max(0,Math.min(w,X)),G=Math.max(0,Math.min(m,Y));e.style.left=`${D}px`,e.style.top=`${G}px`,e.style.right="auto",wt({x:D,y:G})}if(L&&i){d.preventDefault();const w=f.x-R.x,m=f.y-R.y,X=window.innerWidth-i.offsetWidth,Y=window.innerHeight-i.offsetHeight,D=Math.max(0,Math.min(w,X)),G=Math.max(0,Math.min(m,Y));b.x=D,b.y=G,T||(T=requestAnimationFrame(()=>{i&&L&&(i.style.transform=`translate(${b.x}px, ${b.y}px)`,i.style.left="0",i.style.top="0",i.style.right="auto",i.style.bottom="auto"),T=null})),Math.sqrt((f.x-q.x)**2+(f.y-q.y)**2)>5&&(M=!0)}},c=d=>{B&&(B=!1,u&&(u.style.cursor="default"),d.preventDefault()),L&&(L=!1,T&&(cancelAnimationFrame(T),T=null),i&&(i.style.cursor="move",i.style.transition="",M&&(i.style.transform=`translate(${b.x}px, ${b.y}px)`,i.style.left="0",i.style.top="0",i.style.right="auto",i.style.bottom="auto")),M&&d.preventDefault())};document.addEventListener("mousemove",s),document.addEventListener("mouseup",c),document.addEventListener("touchmove",s,{passive:!1}),document.addEventListener("touchend",c,{passive:!1}),document.addEventListener("touchcancel",c,{passive:!1});const l=d=>f=>{f.preventDefault(),f.stopPropagation(),d()},h=e.querySelector("#m3u8-capture-toggle");h&&(h.addEventListener("click",l(()=>F())),h.addEventListener("touchend",l(()=>F()),{passive:!1}));const E=e.querySelector("#m3u8-capture-clear");E&&(E.addEventListener("click",l(()=>ct())),E.addEventListener("touchend",l(()=>ct()),{passive:!1}));const $=e.querySelector("#m3u8-capture-settings");return $&&($.addEventListener("click",l(()=>dt())),$.addEventListener("touchend",l(()=>dt()),{passive:!1})),!U&&!i&&st(),u}function dt(t=y){const e=window.Swal;if(!e)return;const n=tt(),o=k(),r=nt();e.fire({title:"è®¾ç½®",html:`
              <div class="text-left">
                  <label class="block text-sm font-medium text-gray-700 mb-1">WebUI åœ°å€</label>
                  <input id="swal-webui-url" type="text" value="${V()}"
                      class="w-full p-2.5 border border-gray-300 rounded-md mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder="http://localhost:6600">
                  <label class="block text-sm font-medium text-gray-700 mb-1">åª’ä½“æ‰©å±•åï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œç”¨é€—å·æˆ–æ¢è¡Œåˆ†éš”ï¼‰</label>
                  <textarea id="swal-media-ext-list" rows="3"
                      class="w-full p-2.5 border border-gray-300 rounded-md mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder="ä¾‹å¦‚ï¼šm3u8, mp4, mkv, avi, mov, wmv, flv, webm, m4v, ts, m3u, m4a, aac, flac, ape, mp3, wav, ogg, wma">${o.join(", ")}</textarea>
                  <p class="text-xs text-gray-500 mb-4">æ”¯æŒçš„åª’ä½“æ–‡ä»¶æ‰©å±•åï¼Œå°†ç”¨äºè¯†åˆ«å’ŒæŠ“å–åª’ä½“é“¾æ¥</p>
                  <label class="block text-sm font-medium text-gray-700 mb-1">æ’é™¤ç½‘å€è§„åˆ™ï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œæ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ï¼Œä»¥ / å¼€å¤´å’Œç»“å°¾ï¼‰</label>
                  <textarea id="swal-exclude-urls" rows="6"
                      class="w-full p-2.5 border border-gray-300 rounded-md mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder="ä¾‹å¦‚ï¼š&#10;localhost:6600&#10;/example.com/&#10;127.0.0.1">${n}</textarea>
                  <p class="text-xs text-gray-500 mb-4">åŒ¹é…çš„ç½‘å€å°†ä¸å±•ç¤ºé¢æ¿ä¸”ä¸æŠ“å–åª’ä½“é“¾æ¥</p>
                  <div class="flex items-center mb-4">
                      <input id="swal-auto-start" type="checkbox" ${r?"checked":""}
                          class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                      <label for="swal-auto-start" class="ml-2 text-sm font-medium text-gray-700">è‡ªåŠ¨å¼€å§‹ä¸‹è½½</label>
                  </div>
                  <p class="text-xs text-gray-500">å¯ç”¨åï¼Œè·³è½¬åˆ°ä¸‹è½½é¡µé¢æ—¶å°†è‡ªåŠ¨è§¦å‘å¼€å§‹ä¸‹è½½ï¼ˆå»¶è¿Ÿ1ç§’ï¼‰</p>
              </div>
          `,showCancelButton:!0,confirmButtonText:"ä¿å­˜",cancelButtonText:"å–æ¶ˆ",confirmButtonColor:"#3b82f6",width:"600px",preConfirm:()=>{if(!t)return!1;const a=t.getElementById("swal-webui-url"),s=t.getElementById("swal-exclude-urls"),c=t.getElementById("swal-media-ext-list"),l=t.getElementById("swal-auto-start"),h=a?a.value.trim():"",E=s?s.value.trim():"",$=c?c.value.trim():"",d=l?l.checked:!1,f=window.Swal;if(!h)return f.showValidationMessage("WebUI åœ°å€ä¸èƒ½ä¸ºç©º"),!1;const w=$.split(/[,\n\s]+/).map(m=>m.trim()).filter(m=>m);return w.length===0?(f.showValidationMessage("åª’ä½“æ‰©å±•ååˆ—è¡¨ä¸èƒ½ä¸ºç©º"),!1):{url:h,excludeUrls:E,mediaExtList:w,autoStart:d}}}).then(a=>{if(a.isConfirmed&&a.value){const s=a.value;GM_setValue(N,s.url),xt(s.excludeUrls),bt(s.autoStart);const c=gt(s.mediaExtList),l=window.Swal;c&&l?l.fire({icon:"success",title:"è®¾ç½®å·²ä¿å­˜",html:`å·²ä¿å­˜ ${c.length} ä¸ªåª’ä½“æ‰©å±•åç±»å‹`,timer:2e3,showConfirmButton:!1}):l&&l.fire({icon:"error",title:"ä¿å­˜å¤±è´¥",text:"åª’ä½“æ‰©å±•ååˆ—è¡¨æ ¼å¼é”™è¯¯",timer:2e3,showConfirmButton:!1})}})}function ft(t){const e=window.top&&window.top!==window;try{const o=window.open(t,"_blank");if(o&&!o.closed)return!0}catch(o){console.log("[M3U8 Capture] window.open failed:",o)}if(e&&window.top){try{const o=window.top.open(t,"_blank");if(o&&!o.closed)return!0}catch(o){console.log("[M3U8 Capture] window.top.open failed:",o)}try{return window.top.location.href=t,!0}catch(o){console.log("[M3U8 Capture] window.top.location.href failed:",o)}}const n=()=>{const o=window.Swal;o&&o.fire({icon:"info",title:"é“¾æ¥å·²å¤åˆ¶",html:`ç”±äº iframe é™åˆ¶ï¼Œé“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿<br><br><code style="word-break: break-all; background: #f3f4f6; padding: 8px; border-radius: 4px; display: block; font-size: 12px;">${t}</code><br><br>è¯·æ‰‹åŠ¨æ‰“å¼€`,timer:4e3,showConfirmButton:!0,confirmButtonText:"ç¡®å®š"})};return ot(t).then(()=>n()).catch(()=>{const o=window.Swal;o&&o.fire({icon:"warning",title:"æ— æ³•å¤åˆ¶é“¾æ¥",html:`ç”±äº iframe é™åˆ¶ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶å¹¶æ‰“å¼€ï¼š<br><br><code style="word-break: break-all; background: #f3f4f6; padding: 8px; border-radius: 4px; display: block; font-size: 12px;">${t}</code>`,confirmButtonText:"ç¡®å®š"})}),!1}function H(){if(x||!g||!ut())return;z();const t=u?.querySelector("#m3u8-capture-list"),e=u?.querySelector("#m3u8-capture-empty"),n=u?.querySelector("#m3u8-capture-count");if(!t||!e||!n)return;if(n.textContent=g.size.toString(),g.size===0){t.classList.add("hidden"),e.classList.remove("hidden");return}t.classList.remove("hidden"),e.classList.add("hidden"),t.innerHTML="",Array.from(g.values()).sort((r,a)=>a.timestamp-r.timestamp).forEach(r=>{const a=document.createElement("div");a.className="border border-gray-200 rounded-lg p-3 bg-white transition-all duration-200 shadow-sm hover:bg-gray-50 hover:shadow-md";const s=r.title||"",c=r.type.toUpperCase();let l="bg-gray-500";c==="M3U8"||c==="M3U"?l="bg-blue-500":["MP4","MKV","AVI","MOV","WMV","FLV","WEBM","M4V","TS"].includes(c)?l="bg-green-500":["MP3","M4A","AAC","FLAC","APE","WAV","OGG","WMA"].includes(c)&&(l="bg-purple-500"),a.innerHTML=`
              <div class="flex justify-between items-start gap-2 mb-2">
                  <div class="flex-1 min-w-0">
                      <div class="flex items-center gap-1.5 mb-1.5">
                          <span class="font-semibold text-[13px] text-gray-900 overflow-hidden text-ellipsis whitespace-nowrap" title="${s}">${s||"æœªå‘½ååª’ä½“"}</span>
                          <span class="${l} text-white px-2 py-0.5 rounded-xl text-[10px] font-bold">${c}</span>
                      </div>
                      <div class="text-[11px] text-gray-500 overflow-hidden text-ellipsis whitespace-nowrap leading-snug max-w-[320px]" title="${r.url}">${r.url}</div>
                  </div>
              </div>
              <div class="flex gap-2">
                  <button class="m3u8-capture-download-btn flex-1 bg-blue-500 text-white border-none px-3.5 py-2 rounded-md cursor-pointer text-xs font-medium transition-all duration-200 hover:bg-blue-600 hover:-translate-y-0.5" data-url="${encodeURIComponent(r.url)}" data-title="${encodeURIComponent(s)}">
                      è·³è½¬ä¸‹è½½
                  </button>
                  <button class="m3u8-capture-preview-btn bg-green-500 text-white border-none px-3.5 py-2 rounded-md cursor-pointer text-xs font-medium transition-all duration-200 hover:bg-green-600" data-url="${encodeURIComponent(r.url)}">
                      é¢„è§ˆ
                  </button>
                  <button class="m3u8-capture-copy-btn bg-gray-500 text-white border-none px-3.5 py-2 rounded-md cursor-pointer text-xs transition-all duration-200 hover:bg-gray-600" data-url="${r.url}">
                      å¤åˆ¶
                  </button>
              </div>
          `,t.appendChild(a)}),u?.querySelectorAll(".m3u8-capture-download-btn").forEach(r=>{r.addEventListener("click",a=>{a.stopPropagation();const s=decodeURIComponent(r.getAttribute("data-url")||""),c=decodeURIComponent(r.getAttribute("data-title")||""),l=nt()?"&autoStart=1":"",h=`${V()}/page/download?from=capture&action=new${l}&url=${encodeURIComponent(s+(c?`|${c}`:""))}`;ft(h)})}),u?.querySelectorAll(".m3u8-capture-preview-btn").forEach(r=>{r.addEventListener("click",a=>{a.stopPropagation();const s=decodeURIComponent(r.getAttribute("data-url")||""),c=`https://m3u8-player.lzw.me?from=capture&url=${encodeURIComponent(s)}`;ft(c)})}),u?.querySelectorAll(".m3u8-capture-copy-btn").forEach(r=>{r.addEventListener("click",async a=>{a.stopPropagation();const s=r.getAttribute("data-url")||"",c=r.textContent,l=r.className;try{await ot(s),r.textContent="å·²å¤åˆ¶",r.className="m3u8-capture-copy-btn bg-green-500 text-white border-none px-3.5 py-2 rounded-md cursor-pointer text-xs transition-all duration-200",setTimeout(()=>{r.textContent=c,r.className=l},2e3)}catch{const E=window.Swal;if(!E)return;E.fire({icon:"error",title:"å¤åˆ¶å¤±è´¥",text:"è¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥",html:`<code style="word-break: break-all; background: #f3f4f6; padding: 8px; border-radius: 4px; display: block; font-size: 12px;">${s}</code>`,confirmButtonText:"ç¡®å®š"})}})})}const P=new Map;Ut(P);function v(t,e=""){if(t=Ct(t)||t,!t||_(t))return;const n={url:t,title:e||it(),type:St(t),pageUrl:window.location.href,timestamp:Date.now()};if(x){try{window.top?.postMessage({type:"m3u8-capture-link",data:n},"*")}catch(a){console.warn("[M3U8 Capture] Failed to send link to top window:",a)}return}const o=Et(t);P.get(o)?.title||(P.set(o,n),H())}function $t(){if(_())return;x||window.addEventListener("message",n=>{if(n.data?.type==="m3u8-capture-link"&&n.data.data){const o=n.data.data;v(o.url,o.title)}}),Lt(),Mt();const t=()=>{if(!_()){if(x)return A();document.body&&(A(),P.size>0&&H())}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):setTimeout(t,100);let e=location.href;new MutationObserver(()=>{const n=location.href;if(n!==e){if(e=n,_()){F();return}setTimeout(()=>A(),1e3)}}).observe(document,{subtree:!0,childList:!0}),setInterval(()=>{document.body&&!_()&&A()},5e3)}$t()})();
